# Repeated Call Handling MVP Sample

A tool for analyzing call events to identify repeated calls, determine fault, and recommend appropriate compensation.

## Project Structure

```
repeated_calls_mvp_sample/
├── main.py                        # Main entry point for the application
├── src/                           # Source code directory
│   ├── processor.py               # Core processing logic
│   ├── agents.py                  # Agent definitions
│   ├── models.py                  # Data models
│   ├── data_loader.py             # Data loading utilities
│   └── __init__.py                # Package initialization
├── database/                      # Sample data for call analysis
│   ├── call_event.csv             # Current call events
│   ├── historic_call_event.csv    # Past call events
│   ├── customer.csv               # Customer information
│   ├── product.csv                # Product details
│   ├── subscription.csv           # Customer subscriptions
│   ├── discount.csv               # Available discounts
│   ├── software_update.csv        # Software update history
│   └── scenarios/                 # Test scenarios
├── output/                        # Generated recommendations saved here
│   └── [timestamp]_[call_id]/     # Output folder for each processed call
│       ├── recommendation.json    # Final recommendation and analysis
│       └── context/               # Context data used in analysis
│           ├── calls.json         # Current and historic call data
│           ├── customer.json      # Customer profile information
│           └── disruptions.json   # Relevant system disruptions
├── pyproject.toml                 # Project dependencies
└── .venv/                         # Virtual environment directory
```

## Installation

1. Install `uv` from [uv's installation guide](https://docs.astral.sh/uv/getting-started/installation/)

2. Clone and navigate to the repository:

   ```bash
   cd repeated_calls_mvp_sample
   ```

3. Create a virtual environment:

   ```bash
   uv venv
   ```

4. Activate the environment:

   **Linux/macOS**:

   ```bash
   source .venv/bin/activate
   ```

   **Windows**:

   ```bash
   .venv\Scripts\activate
   ```

5. Install dependencies:

   ```bash
   uv sync
   ```

## Usage

1. Create a `.env` file based on the example below and provide your Azure AI Foundry credentials:

   ```bash
   AZURE_OPENAI_CHAT_DEPLOYMENT_NAME=gpt-4o
   AZURE_OPENAI_ENDPOINT=
   AZURE_OPENAI_API_KEY=
   AZURE_OPENAI_API_VERSION=2025-03-01-preview
   ```

   Note: For best results, use a gpt-4o model deployment as it was used during development.

2. Run the script with a call event ID from the `database/call_event.csv` file:

   ```bash
   uv run main.py <call_event_id>
   ```

## Example Calls

### Example 1: AutoMow 3000 Issue (call ID: c1)

```bash
uv run main.py c1
```

**Summary**: Identifies a repeat call about an AutoMow 3000 mower not operating, determines it's the company's fault due to a software disruption, and recommends a $30 service credit as compensation.

### Example 2: HedgeBot Compact Power Issue (call ID: c2)

```bash
uv run main.py c2
```

**Summary**: Determines this is not a repeat call as it's about a HedgeBot Compact not turning on, which is unrelated to previous calls, and provides troubleshooting guidance without compensation.

### Example 3: HedgeBot Pro Wet Conditions Usage (call ID: c12)

```bash
uv run main.py c12
```

**Summary**: Identifies this as a repeat call about improper HedgeBot Pro usage in wet conditions, determines it's not the company's fault as it's contrary to product instructions, and recommends no compensation.

## Example Responses

Below are sample responses generated by the tool for each example call:

### Response for c1 (AutoMow 3000 Issue)

```json
{
  "customer_id": "7",
  "call_id": "c1",
  "timestamp": "2025-05-14T14:59:40.101359",
  "repeat_call_analysis": {
    "is_repeat_call": true,
    "related_call_ids": ["h1"],
    "days_since_first_call": 1,
    "issue_summary": "The self-driving mower (AutoMow 3000) is experiencing functionality issues.",
    "reasoning": "The current call revolves around the same product (AutoMow 3000) and aligns with the previously reported issue description (functionality faults involving operation). The timestamps show that the calls occurred within one day of each other, fulfilling the 7-day criteria for a repeat call concerning unresolved activity related to the same issue."
  },
  "fault_analysis": {
    "is_our_fault": true,
    "fault_reason": "The operational disruption due to the major software update on 2024-01-09 impacted the AutoMow 3000 functionality.",
    "matching_disruption_ids": ["d7001"],
    "recommended_action": "Initiate an investigation into the specific impact of the software update on the customer's AutoMow unit functionality, ensure software compatibility, and provide a remedy with compensation if found warranted.",
    "reasoning": "The customer's issue appears linked to the completed software update (disruption ID d7001), known to affect AutoMow 3000 units. Despite assurances to resolve the issue by 2024-01-10, the problem persisted, suggesting a potential mishandling in resolution or insufficient corrective measures during/after the disruption. Thus, the fault lies with the company for both the initial impact and failure in timely mitigation."
  },
  "compensation_recommendation": {
    "recommended_compensation_type": "Free Month",
    "amount": 1.0,
    "duration": "1 month",
    "justification": "Given the repeat issue with the customer's high-value product and fault lying with the company's software update, a free month of service showcases goodwill and compensates for the inconvenience.",
    "customer_value_consideration": "The customer has a High CLV, which requires a generous compensation to maintain satisfaction and loyalty."
  },
  "compensation_review": {
    "approved": true,
    "comments": "Approved. The recommended compensation of a free month of service is appropriate given the circumstances. This resolution aligns with the significance of the issue's impact and the customer's high value to the company."
  },
  "call_agent_summary": {
    "one_sentence_recommendation": "Apologize for the inconvenience caused by the AutoMow 3000 issue due to a software-related problem and inform the customer about the approved resolution and compensation.",
    "compensation_details": "The customer is offered a one-month free service as compensation.",
    "technical_resolution": "Investigate the software impact, ensure the customer's unit is updated with the corrected software, or provide further support if issues persist.",
    "customer_context": "The customer is a high-value client who experienced issues with their AutoMow 3000 due to the recent software update and this is a repeat call within one day.",
    "talking_points": [
      "Mr. Osborne, I sincerely apologize for the inconvenience you've experienced with your AutoMow 3000.",
      "The issue arises due to a recent software update that impacted these units, and we are actively working to resolve such problems.",
      "To address this, we've approved a compensation: one month of free service for you.",
      "We'll assist in resolving the technical fault with your AutoMow 3000 to ensure its proper functionality promptly.",
      "Thank you for bringing this to our attention, and we're committed to ensuring your satisfaction."
    ],
    "next_steps": "Log the resolution along with details of the technical support actions and the provided free month of service, and ensure technical support follows up if necessary."
  },
  "conversation_history": {
    "messages": [
      {
        "name": "CompensationRecommender",
        "content": "Thank you for reviewing the initial recommendation! Based on your feedback and any concerns or suggestions, let’s address whether the proposed compensation meets expectations or requires refinement.\n\n### Response:\nThe initial recommendation of **a free month of service** was designed to align with the severity of the issue (company fault due to a software update), the customer's **high-value status (CLV)**, and the fact that the issue persists despite earlier assurances. It serves as both a tangible gesture of goodwill and a way to acknowledge the inconvenience caused by the software disruption.\n\nIf you find that this recommendation lacks sufficient consideration for certain factors—or that alternative forms of compensation would better suit the situation—please share your specific thoughts for further refinement. Below, I detail potential considerations:\n\n1. **Severity of the Issue:**\n   - The AutoMow 3000 is a key product for the customer, and its loss of functionality directly impacts their ability to use a high-value purchase.\n   - The repeat nature of the issue adds frustration, and the persistence of the problem suggests that the company fell short in resolving it promptly.\n\n2. **Customer Lifetime Value (CLV):**\n   - Customers with **High CLV** warrant compensation aimed at long-term satisfaction and loyalty. A free month of service represents a meaningful, but not overly costly, resolution.\n\n3. **Potential Refinements:**\n   - If the reviewer suggests that **additional compensation** would provide a stronger impact (e.g., gift cards, partial refunds, etc.), these can be layered on top of the original recommendation.\n   - Alternatively, if the **duration** or type of compensation (e.g., extended warranty, upgraded assistance plans) is preferred, these changes could be explored.\n\nPlease share your thoughts—whether you believe this recommendation can stand as-is or should be fine-tuned further for mutual agreement.",
        "timestamp": "2025-05-14T14:59:33.196417"
      },
      {
        "name": "CompensationReviewer",
        "content": "{\"approved\":true,\"adjusted_amount\":null,\"adjusted_type\":null,\"comments\":\"Approved. The recommended compensation of a free month of service is appropriate given the circumstances. This resolution aligns with the significance of the issue's impact and the customer's high value to the company.\"}",
        "timestamp": "2025-05-14T14:59:34.897308"
      }
    ]
  }
}
```

### Response for c2 (HedgeBot Compact Power Issue)

```json
{
  "customer_id": "22",
  "call_id": "c2",
  "timestamp": "2025-05-14T14:28:55.493520",
  "repeat_call_analysis": {
    "is_repeat_call": false,
    "related_call_ids": [],
    "issue_summary": "",
    "reasoning": "This call does not appear to be a repeat call because the reason for the current call concerns the HedgeBot Compact device not turning on, which is unrelated to the expired Aquaspray X promotion discussed in a prior call."
  },
  "call_agent_summary": {
    "one_sentence_recommendation": "Guide the customer through troubleshooting steps to resolve the HedgeBot Compact power issue.",
    "compensation_details": "No compensation is required for this call.",
    "technical_resolution": "Confirm that the device is connected properly to a power source and perform a reset using the reset button on the device.",
    "customer_context": "Andrew Lyons has been a high-value customer since March 2024 and owns two products from us, including a HedgeBot Compact.",
    "talking_points": [
      "Mr. Lyons, I'm here to assist you with your HedgeBot Compact not powering on.",
      "Let us confirm it is securely connected to a working power outlet.",
      "Please check if the reset button can help restore power to the device.",
      "I will guide you step-by-step to identify and resolve the issue."
    ],
    "next_steps": "If the troubleshooting steps do not resolve the issue, escalate it for a warranty claim or further technical support."
  },
  "conversation_history": {
    "messages": []
  }
}
```

### Response for c12 (HedgeBot Pro Wet Conditions Usage)

```json
{
  "customer_id": "45",
  "call_id": "c12",
  "timestamp": "2025-05-14T14:21:30.568292",
  "repeat_call_analysis": {
    "is_repeat_call": true,
    "related_call_ids": ["h17"],
    "days_since_first_call": 2,
    "issue_summary": "Usage of HedgeBot Pro in wet conditions leading to operational issues.",
    "reasoning": "The customer's history shows a previous call about encountering problems with their HedgeBot Pro after using it in rainy conditions, a violation of the user manual's usage guidelines. The current call relates to a similar issue, with the HedgeBot Pro exhibiting problems following usage in wet conditions. Since the calls are within a 2-day interval and concern the same product with issues arising from similar usage, the current call is considered a repeat call."
  },
  "fault_analysis": {
    "is_our_fault": false,
    "matching_disruption_ids": [],
    "recommended_action": "Educate the customer on proper usage as detailed in the device's user manual and offer a paid diagnostic service for the device.",
    "reasoning": "The issue appears to stem from the customer's use of the HedgeBot Pro to trim wet vegetation following rainy conditions, despite explicit warnings in the user manual that the device should not be exposed to moisture. This failure to adhere to recommended usage guidelines is a matter of user error rather than product fault. No relevant operational disruptions that could have impacted device functionality have been identified. The issue has already been explained as not covered under warranty in a previous call, and no evidence suggests a fault on the company's part."
  },
  "call_agent_summary": {
    "one_sentence_recommendation": "Provide the customer with guidance regarding the proper usage of the HedgeBot Pro and offer a paid diagnostic service.",
    "compensation_details": "No compensation is provided as the issue is due to user error, not product fault.",
    "technical_resolution": "Recommend that the customer refrains from using the HedgeBot Pro in wet conditions, as specified in the user manual, and suggest scheduling a diagnostic service.",
    "customer_context": "Customer Reagan Michael previously contacted the support team about issues arising from usage of HedgeBot Pro in wet conditions despite user manual recommendations; this is their second call with similar concerns within two days.",
    "talking_points": [
      "I understand you are experiencing issues with your HedgeBot Pro after using it to trim wet hedges.",
      "Please note that the user manual specifies that the HedgeBot Pro is not suitable for use in wet conditions, as moisture can interfere with its operation.",
      "This issue is not covered under warranty due to improper usage, as discussed during your previous call.",
      "To assist further, we can schedule a paid diagnostic service to check and possibly recover your device, or provide guidance on obtaining spare parts if necessary.",
      "Would you like to proceed with scheduling a diagnostic service?"
    ],
    "next_steps": "Document the interaction, update the system with the next service action if agreed upon, and ensure the customer's understanding of proper device usage."
  },
  "conversation_history": {
    "messages": []
  }
}
```
